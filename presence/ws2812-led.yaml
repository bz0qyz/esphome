light:
  - platform: esp32_rmt_led_strip
    id: presence_led
    name: "Status LED"
    rgb_order: GRB
    pin: ${pin_presence_led}
    num_leds: 1
    chipset: ws2812

switch:
  - platform: template
    id: led_active_mode
    name: "LED Enable"
    icon: "mdi:led-outline"
    entity_category: "CONFIG"
    optimistic: True
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - logger.log:
            format: "Enabling status LED"
            level: INFO
      - script.execute:
          id: update_presence
          trigger: 0
    on_turn_off:
      - logger.log:
            format: "Disabling status LED"
            level: INFO
      - script.execute:
          id: update_presence
          trigger: 0

number:
  # Presence LED settings
  - platform: template
    name: "LED Presence Brightness"
    id: presence_brightness
    icon: "mdi:brightness-percent"
    entity_category: "CONFIG"
    optimistic: true
    min_value: 0
    max_value: 100
    step: 5
    initial_value: 50
    unit_of_measurement: "%"
    restore_value: true
    on_value:
      - script.execute:
          id: update_presence
          trigger: 0

  # Motion LED settings
  - platform: template
    name: "LED Motion Brightness"
    id: motion_brightness
    icon: "mdi:brightness-percent"
    entity_category: "CONFIG"
    optimistic: true
    min_value: 0
    max_value: 100
    step: 5
    initial_value: 50
    unit_of_measurement: "%"
    restore_value: true
    on_value:
      - script.execute:
          id: update_presence
          trigger: 1

script:
  - id: !extend update_presence
    then:
      - if:
          condition:
            switch.is_off: led_active_mode
          then:
            - script.stop: update_presence
      - if:
          condition:
            lambda: 'return trigger == 0;'
          then:
            - if:
                condition:
                  binary_sensor.is_on: ld2410_presence
                then:
                  # Presence detected - Blue
                  - light.turn_on:
                      id: presence_led
                      red: 0%
                      green: 0%
                      blue: 100%
                      brightness: 50%
                else:
                  # Presence cleared
                  - light.turn_off:
                      id: presence_led
      - if:
          condition:
            lambda: 'return trigger == 1;'
          then:
            - if:
                condition:
                  binary_sensor.is_on: ld2410_moving_target
                then:
                  # Motion detected - Red
                  - light.turn_on:
                      id: presence_led
                      red: 100%
                      green: 0%
                      blue: 0%
                      brightness: 100%
                else:
                  # Motion cleared - check if presence still active
                  - if:
                      condition:
                        binary_sensor.is_on: ld2410_presence
                      then:
                        # Still presence - back to Blue
                        - light.turn_on:
                            id: presence_led
                            red: 0%
                            green: 0%
                            blue: 100%
                            brightness: 50%
                      else:
                        # No presence either - turn off
                        - light.turn_off:
                            id: presence_led